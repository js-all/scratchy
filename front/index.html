<html>
    <head>
        <script src="https://unpkg.com/vue@next"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js "></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/locale/fr.min.js"></script>
        <link rel="stylesheet" href="css/global.css">
        <link rel="stylesheet" href="css/app.css">
        <link rel="stylesheet" href="css/activity_bar.css">
        <link rel="stylesheet" href="css/message_editor.css">
        <link rel="stylesheet" href="css/room_list.css">
        <link rel="stylesheet" href="css/room_editor.css">
        <link rel="stylesheet" href="css/user-list.css">
        <link rel="stylesheet" href="css/messages-list.css">
        <link rel="stylesheet" href="css/login.css">
    </head>
    <body>
        <div id="app">
            <login v-on:login="onLogin($event)" v-bind:is-hidden="isConnected"></login>
            <div class="app_vertical_layout">
                <div class="app_top_horizontal_layout">
                    <room-list v-model:rooms="rooms" v-on:room-selected="displayRoom($event)" v-on:room-quit="quitRoom($event)"></room-list>
                    <div class="app_messages_list_wrapper">
                        <activity-bar v-bind:current-room="currentRoom.title" v-bind:is-writing="isWriting"></activity-bar>
                        <messages v-bind:messages="messages"></messages>
                    </div>
                    <user-list v-bind:users="users"></user-list>
                </div>
                <div class="app_bottom_horizontal_layout">
                    <room-editor v-bind:close-popup="roomEditorClosed" v-on:lock-close="lockRoomEditorClosed()" v-on:create-room="createRoom($event)" v-on:join-room="joinRoom($event)"></room-editor>
                    <message-editor v-bind:clear-message="clearMessageEditor" v-on:lock-clear-message="lockClearMessageEditor()" v-on:send-message="onMessageSend($event)" v-on:start-writing="isWriting = true" v-on:stop-writing="isWriting = false"></message-editor>
                </div>
            </div>
        </div>
        <script src="js/activity_bar.js"></script>
        <script src="js/message_editor.js"></script>
        <script src="js/room_list.js"></script>
        <script src="js/room_editor.js"></script>
        <script src="js/user-list.js"></script>
        <script src="js/message-list.js"></script>
        <script src="js/login.js"></script>
        <script>
            const app = Vue.createApp({
                name: "app",
                data: () => ({
                    selectedRoom: undefined,
                    isWriting: false,
                    loggedUser: undefined,
                    clearMessageEditor: false,
                    roomEditorClosed: false,
                    rooms: [
                        {
                            "_id": {
                                "$oid": "6071ac5176e5bd456a859d9d"
                            },
                            "description": "ma description",
                            "title": "Room 1",
                            "user": []
                        },
                        {
                            "_id": {
                                "$oid": "6071ac5176e5bd456a859d9f"
                            },
                            "description": "ma description",
                            "title": "Room 2",
                            "user": []
                        },
                        {
                            "_id": {
                                "$oid": "6071ac5176e5bd456a859d94"
                            },
                            "description": "ma description",
                            "title": "Room 3",
                            "user": []
                        }
                    ],
                    users: [
                        {
                            "_id": {
                                "$oid": "607ae876f59d21d5a50ac3c9"
                            },
                            "pseudo": "mon pseudo1",
                            "roomsId": []
                        },
                        {
                            "_id": {
                                "$oid": "607ae876f59d21d5a50ac3c2"
                            },
                            "pseudo": "mon pseudo2",
                            "roomsId": []
                        }
                    ],
                    messages: [
                        {_id : {$oid: "459I548383"},content: "Bonjour tata", author: "toto",  timestamp: 1618587750035},
                        {_id : {$oid: "4459493924"},content: "Salut toto", author: "tata",  timestamp: 1618587750035 },
                    ]
                }),
                methods: {
                    onMessageSend(msg) {
                        // TODO: implement something that calls the api and send the message
                        console.log(`message: ${msg}`);
                        this.permitClearMessageEditor();
                        this.messages.push({
                            _id: {
                                $oid: new Date().getTime().toString(16)
                            },
                            author: this.currentUser.pseudo,
                            content: msg,
                            timestamp: Math.floor(new Date().getTime())
                        });
                    },
                    permitClearMessageEditor() {
                        this.clearMessageEditor = true;
                    },
                    lockClearMessageEditor() {
                        this.clearMessageEditor = false;
                    },
                    
                    permitRoomEditorClosed() {
                        this.roomEditorClosed = true;
                    },
                    lockRoomEditorClosed() {
                        this.roomEditorClosed = false;
                    },
                    // this is just example code
                    displayRoom(roomIndex) {
                        // TODO: do whatever
                        console.log(`selected ${this.rooms[roomIndex].title}: rooms[${roomIndex}]`);
                        this.selectedRoom = roomIndex;
                    },
                    quitRoom(index) {
                        if(index == this.selectedRoom) {
                            this.selectedRoom = undefined;
                        }
                        // change the selectedRoom index to make it point to the same room
                        if(index < this.selectedRoom) {
                            this.selectedRoom--;
                        }
                        this.rooms.splice(index, 1);
                    },
                    createRoom(roomData) {
                        // TODO: do whatever
                        console.log(`create room\n title: ${roomData.title}\n desc: ${roomData.description}`);
                        // temporary code to make it look like how it should behave but that really isn't how it'll be done
                        this.rooms.push({
                            _id: {
                                $oid: new Date().getTime().toString(16)
                            },
                            title: roomData.title,
                            description: roomData.description
                        });
                        this.permitRoomEditorClosed()
                    },
                    joinRoom(id) {
                        // TODO: do whatever
                        console.log(`join room '${id}'`);
                        // temporary code to make it look like how it should behave but that really isn't how it'll be done
                        this.rooms.push({
                            _id: {
                                $oid: id
                            },
                            title: "title",
                            description: ""
                        });
                        this.permitRoomEditorClosed()
                    },
                    onLogin(username) {
                        // TODO: do whatever
                        console.log(`logged in as user '${username}'`);
                        // temporary code to make it look like how it should behave but that really isn't how it'll be done
                        this.loggedUser = this.users.length;
                        this.users.push({
                            "_id": {
                                "$oid": new Date().getTime().toString(16)
                            },
                            "pseudo": username,
                            "roomsId": []
                        })
                    }
                },
                computed: {
                    currentRoom() {
                        return this.selectedRoom === undefined ? {_id: null, title: "room not found", description: ""} : this.rooms[this.selectedRoom];
                    },
                    currentUser() {
                        return this.loggedUser === undefined ? {_id: null, pseudo: "user not found", roomsId: []} : this.users[this.loggedUser];
                    },
                    isConnected() {
                        return this.loggedUser !== undefined;
                    }
                },
            });
            app.component("activity-bar", activityBar);
            app.component("message-editor", messageEditor);
            app.component("room-list", roomList);
            app.component("room-editor", roomEditor);
            app.component('user-list',userList);
            app.component('messages',messages);
            app.component("login", login);
            app.mount("#app");
        </script>
    </body>
</html>